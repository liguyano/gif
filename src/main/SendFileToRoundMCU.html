<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>圆形图片与按钮布局</title>
    <link rel="stylesheet" href="style.css">
    <script type="application/javascript" src="script/jquery-3.1.0.min.js"></script>
    <script type="application/javascript" src="script/SendMcu.js"></script>
    <script src="./script/gifshot.min.js"></script>
    <script src="./script/libgif.js"></script>
</head>
<body>
<!-- 替换为 canvas 元素 -->
<!-- 替换为 canvas 元素 -->
<div class="row" id="defaultImg">
    <div class="circle-image">
        <img src="img/round.jpg" alt="Image 1"/>
    </div>
    <div class="circle-image">
        <img src="img/round.jpg" alt="Image 2"/>
    </div>
    <div class="circle-image">
        <img src="img/round.jpg" alt="Image 3"/>
    </div>
</div>
<div class="row" id="canvasRow" style="display: none">
    <div class="circle-image">
        <canvas class="image-canvas" id="myCanvas" width="240" height="240"></canvas>
    </div>
    <div class="circle-image">
        <canvas class="image-canvas"></canvas>
    </div>
    <div class="circle-image">
        <canvas class="image-canvas"></canvas>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <button class="button eyeBtn">eye 1</button>
        <button class="button eyeBtn">eye 2</button>
        <button class="button eyeBtn">eye 3</button>
        <button class="button eyeBtn">eye 4</button>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <button class="button"> 手动切换</button>
        <button class="button"> 自动切换</button>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <button class="button eyeBtn">cartoon 1</button>
        <button class="button eyeBtn">cartoon 2</button>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <button class="button" id="selectImgBtn">IMAGE</button>
        <button class="button" onclick="inputClick()">
            <input class="button" type="file" id="fileInput" style="display: none;" accept="image/gif"/>
            上传文件
        </button>

        <button class="button" id="gif_btn">GIF</button>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <button class="button">OTA 更新</button>
        <button class="button ">联系我们</button>
    </div>
</div>
<div class="row buttons-row">
    <div class="buttons-container">
        <p id="status"></p>
    </div>
</div>
<div id="framesContainer" style="display: none;"></div>
<div id="gifResult" style="display: none;"></div>
<script>
    let frames = [];
    let delays = [];
    document.getElementById('fileInput').addEventListener('change', function (event) {
        frames = [];
        delays = [];
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.display = 'none';  // 隐藏原始 GIF

            img.addEventListener('load', function () {
                const superGif = new SuperGif({gif: img});
                superGif.load(() => {
                    const framesContainer = document.getElementById('framesContainer');
                    framesContainer.innerHTML = '';  // 清空之前的帧
                    for (let i = 1; i <= superGif.get_length(); i++) {
                        superGif.move_to(i - 1);
                        const canvas = superGif.get_canvas();
                        const frameImage = new Image();
                        frameImage.src = canvas.toDataURL();
                        frames.push(frameImage.src);  // 将帧的Base64数据保存到数组中
                        framesContainer.appendChild(frameImage);
                    }
                });
            });

            document.body.appendChild(img);
        };

        reader.readAsDataURL(file);
    });

    document.getElementById('gif_btn').addEventListener('click', function () {
        if (frames.length === 0) {
            alert('请先选择一个 GIF 文件');
            return;
        }
        gifshot.createGIF({
            images: frames,
            gifWidth: 100,
            gifHeight: 100,
            interval: 0.1, // 帧间隔，可以根据需要调整
        }, async function (obj) {
            if (!obj.error) {
                const image = obj.image;
                // base64 to file
                const file = base64ToFile(image, 'result.gif');
                const formData = new FormData();
                formData.append('file', file);
                await sendMessage()
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log('Success:', data)
                        alert('文件上传成功！')
                    })
                    .catch((error) => {
                        console.error('Error:', error)
                        alert('文件上传失败！')
                    })
            }
        });
    });

    function inputClick() {
        document.getElementById('fileInput').click();
    }

    function base64ToFile(base64, fileName) {
        let arr = base64.split(",");
        let mime = arr[0].match(/:(.\*?);/)[1];
        let bstr = atob(arr[1]);
        let n = bstr.length;
        let u8arr = new Uint8Array(n);

        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], fileName, {type: mime});
    }

    function sendMessage() {
        new Promise((resolve, reject) => {
            fetch('/send', {
                method: 'POST',
                body: JSON.stringify({
                    mess: 'ready'
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
        })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data)
                alert('文件发送成功！')
                resolve()
            })
            .catch((error) => {
                console.error('Error:', error)
                alert('文件发送失败！')
                reject()
            })
    }
</script>
</body>
</html>
